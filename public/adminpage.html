<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rare Explorer – Travel Packages</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: white;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 30px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-container img {
      height: 50px;
      width: auto;
      border-radius: 50%;
    }
    .logo-text {
      font-size: 24px;
      font-weight: bold;
    }
    .search-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .search-bar input {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      outline: none;
    }
    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-primary {
      background: linear-gradient(to right, #4f46e5, #06b6d4);
      color: white;
    }
    .btn-secondary {
      background: #475569;
      color: white;
    }
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    .container {
      padding: 20px 30px;
    }
    .flex-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 900px) {
      .card-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .card-grid { grid-template-columns: 1fr; }
    }
    .card {
      background: #1e293b;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }
    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
    }
    .card-content { padding: 15px; }
    .tags {
      display: flex;
      gap: 8px;
      margin: 5px 0;
      flex-wrap: wrap;
    }
    .tag {
      background: #334155;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
    }
    .card-footer {
      display: flex;
      justify-content: flex-end;
      padding: 10px 15px;
      border-top: 1px solid #334155;
      flex-wrap: wrap;
      gap: 5px;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      overflow-y: auto;
      z-index: 1000;
      padding: 30px 10px;
      box-sizing: border-box;
    }
    .modal-content {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      width: 400px;
      max-width: 95%;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      margin: auto;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border-radius: 6px;
      border: none;
      outline: none;
    }
  </style>

  <!--  Firebase + Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB7PKVUrQcL-pEeOnn9XU9D3tgK90WkSU8",
      authDomain: "travelbook-64c34.firebaseapp.com",
      projectId: "travelbook-64c34",
      storageBucket: "travelbook-64c34.appspot.com",
      messagingSenderId: "964725351972",
      appId: "1:964725351972:web:788b5e8361333723fa5ab1",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "UserSignup.html";
    });

    window.logout = function() {
      signOut(auth).then(() => window.location.href = "browsing.html");
    };

    let places = [];
    let bookings = 0;
    let selectedPackage = null;
    let editPackageId = null;

    function formatPHP(value) {
      return "₱" + value.toLocaleString("en-PH", { minimumFractionDigits: 2 });
    }

    async function loadPlaces() {
      const querySnapshot = await getDocs(collection(db, "packages"));
      places = [];
      querySnapshot.forEach((d) => places.push({ id: d.id, ...d.data() }));
      renderPlaces();
    }

    window.renderPlaces = function(filtered = places) {
      const list = document.getElementById("placeList");
      list.innerHTML = "";
      filtered.forEach((p, index) => {
        list.innerHTML += `
          <div class="card">
            <img src="${p.img}" alt="${p.name}">
            <div class="card-content">
              <h3>${p.name}</h3>
              <p>${p.city}</p>
              <p><i>${p.duration}</i></p>
              <div class="tags">
                ${p.tags.map(t => `<span class="tag">${t}</span>`).join("")}
              </div>
              <p><b>${formatPHP(p.price)}</b> / person</p>
            </div>
            <div class="card-footer">
              <button class="btn btn-primary" onclick="openPayment(${index})">Book</button>
              <button class="btn btn-secondary" onclick="openEdit(${index})">Edit</button>
              <button class="btn btn-danger" onclick="deletePackage('${p.id}')">Delete</button>
            </div>
          </div>
        `;
      });
      document.getElementById("stats").innerText = `${places.length} packages · ${bookings} bookings`;
    };

    window.clearSearch = function() {
      document.getElementById("search").value = "";
      renderPlaces();
    };

    window.searchPlaces = function() {
      const query = document.getElementById("search").value.toLowerCase();
      const filtered = places.filter(p => p.name.toLowerCase().includes(query) || p.city.toLowerCase().includes(query));
      renderPlaces(filtered);
    };

    async function loadBookings() {
      const querySnapshot = await getDocs(collection(db, "receipts"));
      const bookingsArray = [];
      querySnapshot.forEach((doc) => bookingsArray.push({ id: doc.id, ...doc.data() }));
      renderBookings(bookingsArray);
    }

    window.renderBookings = function(bookingsArray) {
      const list = document.getElementById("bookingList");
      list.innerHTML = bookingsArray.length === 0 ? "<p>No bookings yet.</p>" : "";
      bookingsArray.forEach((b) => {
        list.innerHTML += `
          <div class="card">
            <img src="${b.packageImage || 'Images/logo.jpg'}" alt="${b.packageName}">
            <div class="card-content">
              <h3>${b.packageName}</h3>
              <p><b>City:</b> ${b.city}</p>
              <p><b>Duration:</b> ${b.duration}</p>
              <p><b>Price:</b> ₱${b.price.toLocaleString('en-PH', {minimumFractionDigits: 2})}</p>
              <p><b>Booker:</b> ${b.payerName}</p>
              <p><b>Email:</b> ${b.payerEmail}</p>
              <p><b>Transaction ID:</b> ${b.transactionId}</p>
              <p><b>Date:</b> ${new Date(b.date).toLocaleString()}</p>
            </div>
          </div>
        `;
      });
    };

    // PayPal modal
    window.openPayment = function(index) {
      selectedPackage = places[index];
      document.getElementById("paymentModal").style.display = "flex";

      document.getElementById("paypal-button").innerHTML = "";
      paypal.Buttons({
        createOrder: (data, actions) => actions.order.create({
          purchase_units: [{
            description: selectedPackage.name,
            amount: { value: selectedPackage.price.toString(), currency_code: "PHP" }
          }]
        }),
        onApprove: (data, actions) => actions.order.capture().then(async (details) => {
          bookings++;
          alert(" Payment successful! Thank you " + details.payer.name.given_name);
          await addDoc(collection(db, "receipts"), {
            packageId: selectedPackage.id,
            packageName: selectedPackage.name,
            city: selectedPackage.city,
            duration: selectedPackage.duration,
            price: selectedPackage.price,
            payerName: details.payer.name.given_name + " " + details.payer.name.surname,
            payerEmail: details.payer.email_address,
            transactionId: details.id,
            currency: details.purchase_units[0].amount.currency_code,
            date: new Date().toISOString(),
            packageImage: selectedPackage.img
          });
          document.getElementById("paymentModal").style.display = "none";
          renderPlaces();
          loadBookings();
        })
      }).render("#paypal-button");
    };

    window.closeModal = function() {
      document.getElementById("paymentModal").style.display = "none";
    };

    // Edit
    window.openEdit = function(index) {
      const p = places[index];
      editPackageId = p.id;
      document.getElementById("editName").value = p.name;
      document.getElementById("editCity").value = p.city;
      document.getElementById("editDuration").value = p.duration;
      document.getElementById("editPrice").value = p.price;
      document.getElementById("editImg").value = p.img;
      document.getElementById("editTags").value = p.tags.join(", ");
      document.getElementById("editModal").style.display = "flex";
    };

    window.saveEdit = async function() {
      if (!editPackageId) return;
      const ref = doc(db, "packages", editPackageId);
      await updateDoc(ref, {
        name: document.getElementById("editName").value,
        city: document.getElementById("editCity").value,
        duration: document.getElementById("editDuration").value,
        price: parseFloat(document.getElementById("editPrice").value),
        img: document.getElementById("editImg").value,
        tags: document.getElementById("editTags").value.split(",").map(t => t.trim())
      });
      document.getElementById("editModal").style.display = "none";
      loadPlaces();
    };

    window.deletePackage = async function(id) {
      if (confirm("Are you sure you want to delete this package?")) {
        await deleteDoc(doc(db, "packages", id));
        loadPlaces();
      }
    };

    window.closeEditModal = function() {
      document.getElementById("editModal").style.display = "none";
    };

    // Add
    window.openAdd = function() {
      document.getElementById("addModal").style.display = "flex";
    };

    window.saveAdd = async function() {
      const name = document.getElementById("addName").value;
      const city = document.getElementById("addCity").value;
      const duration = document.getElementById("addDuration").value;
      const price = parseFloat(document.getElementById("addPrice").value);
      const img = document.getElementById("addImg").value;
      const tags = document.getElementById("addTags").value.split(",").map(t => t.trim());
      await addDoc(collection(db, "packages"), { name, city, duration, price, img, tags });
      document.getElementById("addModal").style.display = "none";
      loadPlaces();
    };

    window.closeAddModal = function() {
      document.getElementById("addModal").style.display = "none";
    };

    loadPlaces();
    loadBookings();
  </script>
</head>
<body>
<header>
  <div class="logo-container">
    <img src="Images/logo.jpg" alt="Rare Explorer Logo">
    <span class="logo-text">RareExplorer Travel & Tours</span>
  </div>
  <div class="search-bar">
    <input type="text" id="search" placeholder="Search package or city..." onkeyup="searchPlaces()">
    <button class="btn btn-secondary" onclick="clearSearch()">Clear</button>
    <button class="btn btn-primary" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">
  <div class="flex-header">
    <div id="stats"></div>
    <button class="btn btn-primary" onclick="openAdd()">+ Add Package</button>
  </div>
  <div id="placeList" class="card-grid"></div>
</div>

<div class="container">
  <h2>Booking List</h2>
  <div id="bookingList" class="card-grid"></div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Edit Package</h3>
    <input type="text" id="editName" placeholder="Package Name">
    <input type="text" id="editCity" placeholder="City">
    <input type="text" id="editDuration" placeholder="Duration">
    <input type="number" id="editPrice" placeholder="Price">
    <input type="text" id="editImg" placeholder="Image URL">
    <input type="text" id="editTags" placeholder="Tags (comma separated)">
    <br><br>
    <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
  </div>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h3>Add New Package</h3>
    <input type="text" id="addName" placeholder="Package Name">
    <input type="text" id="addCity" placeholder="City">
    <input type="text" id="addDuration" placeholder="Duration">
    <input type="number" id="addPrice" placeholder="Price">
    <input type="text" id="addImg" placeholder="Image URL">
    <input type="text" id="addTags" placeholder="Tags (comma separated)">
    <br><br>
    <button class="btn btn-primary" onclick="saveAdd()">Add</button>
    <button class="btn btn-secondary" onclick="closeAddModal()">Cancel</button>
  </div>
</div>
</body>
</html>
